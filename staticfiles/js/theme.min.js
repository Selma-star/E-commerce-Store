"use strict";

(function () {
  // Handle dropdown toggle in menus
  document.querySelectorAll(".dropdown-menu a.dropdown-toggle").forEach(function (el) {
    el.addEventListener("click", function (e) {
      const nextSubMenu = this.nextElementSibling;

      if (!nextSubMenu.classList.contains("show")) {
        this.closest(".dropdown-menu").querySelectorAll(".show").forEach(function (submenu) {
          submenu.classList.remove("show");
        });
      }

      nextSubMenu.classList.toggle("show");

      const parentDropdown = this.closest("li.nav-item.dropdown.show");
      if (parentDropdown) {
        parentDropdown.addEventListener("hidden.bs.dropdown", function () {
          document.querySelectorAll(".dropdown-submenu .show").forEach(function (submenu) {
            submenu.classList.remove("show");
          });
        });
      }

      e.stopPropagation();
    });
  });

  // Bootstrap tooltips
  const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  tooltips.forEach((el) => new bootstrap.Tooltip(el));

  // Quantity input (plus / minus)
  document.querySelectorAll(".input-group").forEach(function (group) {
    group.addEventListener("click", function (e) {
      const target = e.target;
      const field = target.getAttribute("data-field");
      const input = group.querySelector(`input[name="${field}"]`);
      let value = parseInt(input.value, 10) || 0;

      if (target.classList.contains("button-plus")) {
        e.preventDefault();
        input.value = value + 1;
      }

      if (target.classList.contains("button-minus")) {
        e.preventDefault();
        if (value > 0) {
          input.value = value - 1;
        }
      }
    });
  });

  // Bootstrap popovers
  const popovers = document.querySelectorAll('[data-bs-toggle="popover"]');
  popovers.forEach((el) => new bootstrap.Popover(el));

  // Star rating (raterJs)
  document.querySelectorAll(".rater").forEach((el) => {
    raterJs({
      starSize: 20,
      element: el,
      rateCallback: function (rate, done) {
        this.setRating(rate);
        done();
      },
    });
  });

  // Smooth scroll for sidebar links
  const navLinks = document.querySelectorAll(".sidebar-nav-fixed a");
  navLinks.forEach(function (link) {
    link.addEventListener("click", function (e) {
      if (
        location.pathname.replace(/^\//, "") === this.pathname.replace(/^\//, "") &&
        location.hostname === this.hostname
      ) {
        let target = document.querySelector(this.hash);
        if (target) {
          e.preventDefault();
          window.scrollTo({ top: target.offsetTop - 90, behavior: "smooth" });

          if (!target.matches(":focus")) {
            target.setAttribute("tabindex", "-1");
            target.focus();
          }

          navLinks.forEach((link) => link.classList.remove("active"));
          this.classList.add("active");
        }
      }
    });
  });

  // Flatpickr date picker
  document.querySelectorAll(".flatpickr").forEach((el) => {
    flatpickr(el, {
      disableMobile: true,
      allowInput: true,
      dateFormat: "d/m/Y",
    });
  });

  // Stop event on collapse
  document.querySelectorAll(".stopevent").forEach((el) => {
    el.addEventListener("off.bs.collapse.data-api", function (e) {
      e.stopPropagation();
    });
  });

  // Check all checkboxes
  const checkAll = document.querySelector("#checkAll");
  if (checkAll) {
    checkAll.addEventListener("click", function () {
      document.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
        if (checkbox !== checkAll) checkbox.checked = checkAll.checked;
      });
    });
  }

  // Live alert button
  const alertPlaceholder = document.getElementById("liveAlertPlaceholder");
  const alertButton = document.getElementById("liveAlertBtn");

  if (alertPlaceholder && alertButton) {
    alertButton.addEventListener("click", function () {
      const alertType = "success";
      const message = "Nice, you triggered this alert message!";

      const alertHTML = `
        <div class="alert alert-${alertType} alert-dismissible" role="alert">
          <div>${message}</div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;

      const alertDiv = document.createElement("div");
      alertDiv.innerHTML = alertHTML;
      alertPlaceholder.append(alertDiv);
    });
  }

  // Price range slider
  const priceSlider = document.getElementById("priceRange");
  const priceValue = document.getElementById("priceRange-value");

  if (priceSlider && priceValue) {
    noUiSlider.create(priceSlider, {
      connect: true,
      behaviour: "tap",
      start: [49, 199],
      range: {
        min: [6],
        max: [300],
      },
      format: wNumb({
        decimals: 1,
        thousand: ".",
        prefix: "$",
      }),
    });

    priceSlider.noUiSlider.on("update", function (values) {
      priceValue.innerHTML = values.join(" - ");
    });
  }

  // File input image preview
  document.querySelectorAll(".file-input").forEach((input) => {
    input.addEventListener("change", function () {
      const imgPreview = input.closest(".form-group").querySelector(".image");
      const reader = new FileReader();

      reader.onload = function (e) {
        imgPreview.setAttribute("src", e.target.result);
      };

      if (input.files[0]) {
        reader.readAsDataURL(input.files[0]);
      }
    });
  });
})();

// Tag input using Tagify
const tagsInput = document.querySelector("input[name=tags]");
if (tagsInput) {
  new Tagify(tagsInput);
}
